flowchart TD
  Inbound["/whatsapp/webhook inbound message"]
  Msg{Message text}
  Inbound --> Msg
  Msg -->|"pnr <CODE>"| PNR["Lookup booking by PNR\n→ Return ticket link or 404"]
  Msg -->|ticket| Last["Find latest booking for user\n→ Return ticket link or fallback message"]
  Msg -->|restart / start| Reset["clear_session(from_number)"] --> Source
  Msg -->|other| Step{session.step}
  Step -->|source| Source["Ask/parse source city (1..4 or free text)\n→ to_iata"]
  Source -->|valid| Dest
  Source -->|invalid| Source
  Step -->|destination| Dest["Ask/parse destination city (1..4 or free text)\n→ to_iata; must differ from source"]
  Dest -->|valid| Date
  Dest -->|invalid| Dest
  Step -->|date| Date["Show 3-month calendar\nAccept date with optional time\nValidate: blackout + min advance"]
  Date -->|valid with time| Flights
  Date -->|date only| Time
  Date -->|invalid| Date
  Step -->|time| Time["Offer preset times (06,09,12,15,18,21) that satisfy min-advance\nOr parse HH:MM / 9am"]
  Time -->|valid| Flights
  Time -->|invalid| Time
  Step -->|flights| Flights["Show 3 flight options (mock_search)\nReply 1..3"]
  Flights -->|1..3| PaxCount
  Flights -->|invalid| Flights
  Step -->|passengers_count| PaxCount["Ask number of passengers 1..4"]
  PaxCount -->|valid| PaxDetails
  PaxCount -->|invalid| PaxCount
  Step -->|details| PaxDetails["Loop N times: collect 'Full Name, email' (email required)\nUpdate user.email if present"]
  PaxDetails -->|done| Seats
  PaxDetails -->|invalid| PaxDetails
  Step -->|seats| Seats["Seat selection: 'auto' or list (e.g., 12A 12B)\nValidate rows 5–30, A–F; fill missing with auto"]
  Seats -->|valid| Confirm
  Seats -->|invalid| Seats
  Step -->|confirm| Confirm["User replies 'confirm' (also accepted from legacy 'payment' step)"]
  Confirm --> Issue
  Issue["Issue ticket:\n• generate_ticket_pdf → PNR, seats[], gate\n• Save PDF in /tickets\n• Twilio: send media message\n• Persist Booking.flight_meta (pnr, seats, gate, ticket_id/url, passengers, depart_at)\n• clear_session"] --> Done["Reply TwiML with link + PNR/Seats/Gate"]

